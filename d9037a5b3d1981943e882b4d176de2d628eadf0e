{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "594d68db_8c69b8e6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 31604
      },
      "writtenOn": "2023-06-23T14:05:46Z",
      "side": 1,
      "message": "I\u0027ve been seeing an issue with Pixel 6 series (maybe other devices are affected, too) where after connecting to certain power sources, especially non-computer USB ports, charge_deadline is still not a writable node, same as if there is no power connected. Adding a 1-second delay fixes that, but this change works better, apart from the errors in logcat for the early failed attempts.",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "788d4c56_046e03d9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 31578
      },
      "writtenOn": "2023-06-23T16:14:19Z",
      "side": 1,
      "message": "Thanks! So if I understand correctly, if the deadline fails to set, it will retry setting the deadline on next battery_changed intent",
      "parentUuid": "594d68db_8c69b8e6",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e935ca36_4ff443ff",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 31604
      },
      "writtenOn": "2023-06-23T16:23:52Z",
      "side": 1,
      "message": "Yes, that\u0027s my understanding of what\u0027s happening. Here\u0027s what I see in logs, after the additional log lines change 359890. It all happens within a short timeframe.\n\n```\n06-23 12:21:44.043  1000  2631  2631 I LineageHealth: Power connected, start monitoring battery\n06-23 12:21:44.044  1000  2631  2631 I LineageHealth: Current time is 12:21:44 PM\n06-23 12:21:44.044  1000  2631  2631 I LineageHealth: Target time is 10:00:00 PM\n06-23 12:21:44.046  1000  2631  2631 I LineageHealth: Setting charge deadline: Target time: 10:00:00 PM\n06-23 12:21:44.046  1000  2631  2631 I LineageHealth: Setting charge deadline: Deadline (seconds): 34695\n06-23 12:21:44.048  1000   777   777 E vendor.lineage.health-service.default: Failed to write to charging deadline node: Invalid argument\n06-23 12:21:44.051  1000  2631  2631 E LineageHealth: Failed to set charge deadline\n06-23 12:21:44.051  1000  2631  2631 E LineageHealth: java.lang.IllegalStateException: \n[...]\n06-23 12:21:44.053  1000  2631  2631 I LineageHealth: Current time is 12:21:44 PM\n06-23 12:21:44.053  1000  2631  2631 I LineageHealth: Target time is 10:00:00 PM\n06-23 12:21:44.053  1000  2631  2631 I LineageHealth: Setting charge deadline: Current time: 12:21:44 PM\n06-23 12:21:44.053  1000  2631  2631 I LineageHealth: Setting charge deadline: Target time: 10:00:00 PM\n06-23 12:21:44.053  1000  2631  2631 I LineageHealth: Setting charge deadline: Deadline (seconds): 34695\n06-23 12:21:44.054  1000   777   777 E vendor.lineage.health-service.default: Failed to write to charging deadline node: Invalid argument\n06-23 12:21:44.054  1000  2631  2631 E LineageHealth: Failed to set charge deadline\n06-23 12:21:44.054  1000  2631  2631 E LineageHealth: java.lang.IllegalStateException: \n[...]\n06-23 12:21:44.116  1000  2631  2631 I LineageHealth: Current time is 12:21:44 PM\n06-23 12:21:44.116  1000  2631  2631 I LineageHealth: Target time is 10:00:00 PM\n06-23 12:21:44.116  1000  2631  2631 I LineageHealth: Setting charge deadline: Current time: 12:21:44 PM\n06-23 12:21:44.116  1000  2631  2631 I LineageHealth: Setting charge deadline: Target time: 10:00:00 PM\n06-23 12:21:44.116  1000  2631  2631 I LineageHealth: Setting charge deadline: Deadline (seconds): 34695\n06-23 12:21:44.204  1000  2631  2631 I LineageHealth: Current time is 12:21:44 PM\n06-23 12:21:44.205  1000  2631  2631 I LineageHealth: Target time is 10:00:00 PM\n06-23 12:21:44.235  1000  2631  2631 I LineageHealth: Current time is 12:21:44 PM\n06-23 12:21:44.235  1000  2631  2631 I LineageHealth: Target time is 10:00:00 PM\n```",
      "parentUuid": "788d4c56_046e03d9",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8688b577_67f2cadf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 31578
      },
      "writtenOn": "2023-06-23T16:28:06Z",
      "side": 1,
      "message": "yes, this makes sense",
      "parentUuid": "e935ca36_4ff443ff",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ddcdc34_a0cacb7c",
        "filename": "lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java",
        "patchSetId": 1
      },
      "lineNbr": 594,
      "author": {
        "id": 31578
      },
      "writtenOn": "2023-06-28T08:33:18Z",
      "side": 1,
      "message": "`t` might be null here.",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1122d6a_ba6ca16a",
        "filename": "lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java",
        "patchSetId": 1
      },
      "lineNbr": 594,
      "author": {
        "id": 31578
      },
      "writtenOn": "2023-06-28T08:37:36Z",
      "side": 1,
      "message": "```diff\n--- diff --git a/lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java b/lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java\nindex aac5f16c..2589dd16 100644\n--- a/lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java\n+++ b/lineage/lib/main/java/org/lineageos/platform/internal/health/ChargingControlController.java\n@@ -578,16 +578,18 @@ public class ChargingControlController extends LineageHealthFeature {\n         }\n \n         long deadline \u003d 0;\n+        final long targetTime;\n         final ChargeTime t \u003d getChargeTime();\n \n         if (!mConfigEnabled || t \u003d\u003d null || mIsControlCancelledOnce) {\n             deadline \u003d -1;\n+            targetTime \u003d 0;\n             Log.i(TAG, \"Canceling charge deadline\");\n         } else {\n             if (t.getTargetTime() \u003d\u003d mSavedTargetTime) {\n                 return;\n             }\n-            final long targetTime \u003d t.getTargetTime();\n+            targetTime \u003d t.getTargetTime();\n             final long currentTime \u003d System.currentTimeMillis();\n             deadline \u003d (targetTime - currentTime) / 1000;\n             Log.i(TAG, \"Setting charge deadline: Current time: \" + msToString(currentTime));\n@@ -597,7 +599,7 @@ public class ChargingControlController extends LineageHealthFeature {\n \n         try {\n             mChargingControl.setChargingDeadline(deadline);\n-            mSavedTargetTime \u003d t.getTargetTime();\n+            mSavedTargetTime \u003d targetTime;\n         } catch (IllegalStateException | RemoteException | UnsupportedOperationException e) {\n             Log.e(TAG, \"Failed to set charge deadline\", e);\n         }\n\n```",
      "parentUuid": "9ddcdc34_a0cacb7c",
      "revId": "d9037a5b3d1981943e882b4d176de2d628eadf0e",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71"
    }
  ]
}